// Update these functions in the script section of your HTML:

function str2ab(str) {
    const buf = new Uint8Array(str.length);
    for (let i = 0; i < str.length; i++) {
        buf[i] = str.charCodeAt(i);
    }
    return buf;
}

function base64UrlEncode(str) {
    return btoa(str)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
}

function base64UrlDecode(str) {
    // Add removed padding
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    while (str.length % 4) {
        str += '=';
    }
    return str;
}

function arrayBufferToBase64Url(arrayBuffer) {
    const bytes = new Uint8Array(arrayBuffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return base64UrlEncode(binary);
}

function generate256BitSecret() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return arrayBufferToBase64Url(array);
}

function generateUnsignedJWT() {
    const header = {
        alg: 'HS256',
        typ: 'JWT'
    };

    // Updated timestamp
    const specificDate = new Date('2025-01-12T21:55:33Z');
    const iat = Math.floor(specificDate.getTime() / 1000);
    const exp = iat + (2 * 365 * 24 * 60 * 60); // 2 years from iat

    const payload = {
        role: 'anon',
        iss: 'fortunestoldco',
        iat: iat,
        exp: exp
    };

    const encodedHeader = base64UrlEncode(JSON.stringify(header));
    const encodedPayload = base64UrlEncode(JSON.stringify(payload));
    
    return `${encodedHeader}.${encodedPayload}`;
}

async function signJWT(token, secret) {
    if (!token || !secret) {
        throw new Error('Both token and secret are required');
    }

    try {
        // Properly decode the base64url secret
        const decodedSecret = atob(base64UrlDecode(secret));
        
        const keyMaterial = await crypto.subtle.importKey(
            'raw',
            str2ab(decodedSecret),
            { name: 'HMAC', hash: 'SHA-256' },
            false,
            ['sign']
        );

        const signature = await crypto.subtle.sign(
            'HMAC',
            keyMaterial,
            str2ab(token)
        );

        return `${token}.${arrayBufferToBase64Url(signature)}`;
    } catch (error) {
        console.error('Signing error:', error);
        throw error;
    }
}
